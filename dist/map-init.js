"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Map=function(){function e(t,i,n){_classCallCheck(this,e),this.element=document.getElementById(t);try{var o=this.element.getAttribute("data-config");this.customConfig=JSON.parse(o)}catch(e){this.customConfig=[],console.log(e)}this.config={accessToken:"pk.eyJ1Ijoid2lqbmVtZW5qZW1lZSIsImEiOiJjaWgwZjB4ZGwwMGdza3FseW02MWNxcmttIn0.l-4VI25pfA5GKukRQTXnWA",style:"mapbox://styles/wijnemenjemee/cjcywszq502re2sobjc8d1e0z",hostContainer:t,center:[4.9,52.37],zoom:10.2,pitch:0,bearing:0,scrollZoom:!1},this.session={incarnation:"old",origin:null,destination:null,data:{},route:null},this.config.origins=i?JSON.parse(i):{},this.config.origins=JSON.parse(i),this._callToAction=document.getElementById("call-to-action"),this._listContainer=document.getElementById("list-container"),this._routeBlock=document.getElementById("route-block"),this._routeSelect=document.getElementById("route-switch"),this._newOrigin=document.getElementById("new-origin"),this.interactionPopup=new InteractionPopup}return _createClass(e,[{key:"init",value:function(){var e=this,t=new MapWebGL(e.config);e._map=t.create(),e._background=new Background(e._map,e.config),e._origin=new Origin(e._map,e.config),e._points=new Points(e._map,e.config),e._lines=new Lines(e._map,e.config),e._map.on("style.load",function(){e._points.addOrigins(),e._initMap()}),e._newOrigin.addEventListener("click",function(){e._clearOrigin()},!1),e._routeSelect.addEventListener("click",function(){e._routeSwitch(this)},!1)}},{key:"_initMap",value:function(){var e=this;e._points.drawOrigins(),e._originList(),e._map.on("mouseover","origins",function(t){e._highlightOrigin(t.features[0].properties.naam)}),e._map.on("mouseout","origins",function(t){e._unhighlightOrigin()}),e._map.on("click","origin-labels",function(t){e._selectOrigin(t.features[0].properties.originId,"")})}},{key:"_originList",value:function(){var e=this;e._callToAction.innerHTML="<span>Kies</span> een <span>startpunt</span>",[].slice.call(e._listContainer.querySelectorAll("li")).forEach(function(t){var i=t.getAttribute("data-name"),n=t.getAttribute("data-origin-id"),o=t.getAttribute("data-filename");t.addEventListener("mouseover",function(){e._highlightOrigin(i)},!1),t.addEventListener("mouseout",function(){e._unhighlightOrigin()},!1),t.addEventListener("click",function(){e._selectOrigin(n,o)},!1)})}},{key:"_highlightOrigin",value:function(e){}},{key:"_unhighlightOrigin",value:function(){}},{key:"_selectOrigin",value:function(e,t){var i=this;i.session.origin=e,i.config.origins.features.forEach(function(t){t.properties.state="inactive",t.properties.originId===e&&(t.properties.state="origin")}),this._map.getSource("origins").setData(i.config.origins);var n="http://localhost:8080/api/route/"+e;axios.get(n).then(function(e){200!==e.status&&console.log("foutje bedankt"),i.session.data={},i.session.data.originData=e.data,i._destinationList()})}},{key:"_destinationList",value:function(){var e=this;e._callToAction.innerHTML="<span>Kies</span> een <span>bestemming</span>";var t=e._listContainer.querySelector("#origin-list"),i=t.cloneNode(!0);e._listContainer.removeChild(t),e._listContainer.appendChild(i);var n=[].slice.call(e._listContainer.querySelectorAll("li"));n.forEach(function(t){var i=(t.getAttribute("data-name"),t.getAttribute("data-origin-id"));t.getAttribute("data-filename");t.addEventListener("mouseover",function(){},!1),t.addEventListener("mouseout",function(){},!1),t.addEventListener("click",function(){e._initRoute(i)},!1)}),n.find(function(t){return t.getAttribute("data-origin-id")==e.session.origin}).classList.add("active")}},{key:"_initRoute",value:function(e){var t=this;t.session.destination=e,t.session.route=t.session.origin+"_"+e,t.config.origins.features.forEach(function(t){"origin"!==t.properties.state&&(t.properties.state="inactive"),t.properties.originId===e&&(t.properties.state="destination")}),t._map.getSource("origins").setData(t.config.origins);var i=[],n=[];t.session.data.originData.forEach(function(t){t.properties.routeId.split("_")[1]===e&&(t.properties.routeId.split("_")[2].indexOf("oud")>-1?n.push(t):t.properties.routeId.split("_")[2].indexOf("nieuw")>-1&&i.push(t))}),t.session.data.routes=[n,i],t._setRouteInfo(t.session.data.routes),t.session.data.routes.forEach(function(e){var i=e[0].properties.routeId.split("_")[2];console.log(i);var n={type:"FeatureCollection",features:e};void 0===t._map.getSource("routes-"+i)?(t._map.addSource("routes-"+i,{type:"geojson",data:n}),setTimeout(function(){t._lines.drawOldLayers(),t._lines.drawNewLayers(),t._points.drawTransfers(t.session.route),t._switchRouteBlockColor(),t._switchRouteLayers(t.session.route)},1e3)):t._map.getSource("routes-"+i).setData(n)})}},{key:"_showDestinations",value:function(){var e=this,t={};t.layers=["destinations"],e.config.destinations=e._filterDestinations(e._map.queryRenderedFeatures(t))}},{key:"_setRouteInfo",value:function(e){var t=this;t._routeBlock.innerHTML="";var i=document.createElement("h3");i.innerHTML=e[0][0].properties.trajectNaam;var n=document.createElement("ul"),o=[];e.forEach(function(e){var t=void 0;t=e[0]&&!0===e[0].properties.isNieuw?"Nieuwe route":"Huidige route";var i=document.createElement("li"),r=document.createElement("input");r.type="checkbox",r.name=e[0].properties.routeId,r.checked=!0,i.appendChild(r);var s=document.createElement("label");s.innerHTML=t,i.appendChild(s);var a=document.createElement("ul");e.forEach(function(e){if("LineString"===e.geometry.type){var t=void 0;t="trein"!==e.properties.transport_type?e.properties.transport_nrs.join(" "):"";var i=document.createElement("li"),n="<span>"+e.properties.transport_type+"</span> <span>"+t+"</span><span> : </span><span>"+e.properties.start_naam+"</span><span> - </span></span><span>"+e.properties.end_naam+"</span>";i.innerHTML=n,a.appendChild(i)}}),i.appendChild(a),n.appendChild(i),o.push(e[0].properties.routeId)}),t._routeBlock.appendChild(i),t._routeBlock.appendChild(n)}},{key:"_switchRouteLayers",value:function(e){self=this,"old"===self.session.incarnation?self._showOld(e):self._showNew(e)}},{key:"_switchRouteBlockColor",value:function(){self=this,"old"===self.session.incarnation?(self._routeBlock.querySelector("#route-block > ul > li:nth-child(1)").style.background=purple,self._routeBlock.querySelector("#route-block > ul > li:nth-child(2)").style.background=black):(self._routeBlock.querySelector("#route-block > ul > li:nth-child(1)").style.background=black,self._routeBlock.querySelector("#route-block > ul > li:nth-child(2)").style.background=purple)}},{key:"_showNew",value:function(){var e=this;console.log(e.session.route),e._map.setLayoutProperty("route-bus_new","visibility","visible"),e._map.setLayoutProperty("route-metro_new","visibility","visible"),e._map.setLayoutProperty("route-tram_new","visibility","visible"),e._map.setLayoutProperty("route-train_new","visibility","visible"),e._map.setLayoutProperty("route-bus_old","visibility","none"),e._map.setLayoutProperty("route-metro_old","visibility","none"),e._map.setLayoutProperty("route-tram_old","visibility","none"),e._map.setLayoutProperty("route-train_old","visibility","none"),e._map.setLayoutProperty("transfers-new","visibility","visible"),e._map.setLayoutProperty("transfer-labels-new","visibility","visible"),e._map.setLayoutProperty("transfers-old","visibility","none"),e._map.setLayoutProperty("transfer-labels-old","visibility","none")}},{key:"_showOld",value:function(){var e=this;e._map.setLayoutProperty("route-bus_new","visibility","none"),e._map.setLayoutProperty("route-metro_new","visibility","none"),e._map.setLayoutProperty("route-tram_new","visibility","none"),e._map.setLayoutProperty("route-train_new","visibility","none"),e._map.setLayoutProperty("route-bus_old","visibility","visible"),e._map.setLayoutProperty("route-metro_old","visibility","visible"),e._map.setLayoutProperty("route-tram_old","visibility","visible"),e._map.setLayoutProperty("route-train_old","visibility","visible"),e._map.setLayoutProperty("transfers-new","visibility","none"),e._map.setLayoutProperty("transfer-labels-new","visibility","none"),e._map.setLayoutProperty("transfers-old","visibility","visible"),e._map.setLayoutProperty("transfer-labels-old","visibility","visible")}},{key:"_setBoundingBox",value:function(){var e=this,t=e._map.queryRenderedFeatures({layers:["origins","destinations","transfers"]}),i={type:"FeatureCollection",features:t},n=turf.bbox(i);e._map.fitBounds(n,{padding:{top:100,bottom:100,left:100,right:100},linear:!0})}},{key:"_routeSwitch",value:function(e){var t=this;if("old"===this.session.incarnation){this.session.incarnation="new";var i=t.session.data.routes[1][0].properties.routeId;t._switchRouteLayers(i)}else{this.session.incarnation="old";var n=t.session.data.routes[0][0].properties.routeId;t._switchRouteLayers(n)}t._switchRouteBlockColor()}},{key:"_filterOrigins",value:function(e){return{type:"FeatureCollection",features:e.features.filter(function(e,t,i){return i.map(function(e){return e.properties.naam}).indexOf(e.properties.naam)===t&&"herkomst"==e.properties.function})}}},{key:"_filterDestinations",value:function(e){var t=[];return e.filter(function(e){return!(t.indexOf(e.properties.naam)>-1)&&(t.push(e.properties.naam),!0)})}},{key:"_filterRoutes",value:function(e){var t=[];return e.filter(function(e){return!(t.indexOf(e.start_id)>-1)&&(t.push(e.start_id),!0)})}},{key:"_clearOrigin",value:function(){var e=this;this.session={origin:null,destination:null},this._listContainer.innerHTML="",e._map.getStyle().layers.forEach(function(t){(t.id.indexOf("route-")>-1||t.id.indexOf("origin")>-1||t.id.indexOf("destination")>-1)&&e._map.removeLayer(t.id)}),e._initMap()}}]),e}();