"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),Map=function(){function e(t,i,r){_classCallCheck(this,e),this.element=document.getElementById(t);try{var n=this.element.getAttribute("data-config");this.customConfig=JSON.parse(n)}catch(e){this.customConfig=[],console.log(e)}this.nightview=!1,this.config={accessToken:"pk.eyJ1Ijoid2lqbmVtZW5qZW1lZSIsImEiOiJjaWgwZjB4ZGwwMGdza3FseW02MWNxcmttIn0.l-4VI25pfA5GKukRQTXnWA",style:"mapbox://styles/wijnemenjemee/cjcywszq502re2sobjc8d1e0z",hostContainer:t,center:[4.9,52.37],zoom:10.2,pitch:0,bearing:0,scrollZoom:!1},this.options={filters:!0,referenceList:!0},this.session={origin:null,destination:null},this.config.origins=i?JSON.parse(i):{},this.config.origins=JSON.parse(i),this._callToAction=document.getElementById("call-to-action"),this._listContainer=document.getElementById("list-container"),this._routeBlock=document.getElementById("route-block"),this._viewSelect=document.getElementById("view-select"),this._newOrigin=document.getElementById("new-origin"),this.interactionPopup=new InteractionPopup}return _createClass(e,[{key:"init",value:function(){var e=this,t=new MapWebGL(e.config);e._map=t.create(),e._background=new Background(e._map,e.config),e._origin=new Origin(e._map,e.config),e._points=new Points(e._map,e.config),e._lines=new Lines(e._map,e.config),e._map.on("style.load",function(){e._points.addOrigins(),e._initMap()}),e._viewSelect.addEventListener("click",function(){e._switchView()},!1),e._newOrigin.addEventListener("click",function(){e._clearOrigin()},!1)}},{key:"_initMap",value:function(){var e=this;e._points.drawOrigins(),e._originList(),e._map.on("mouseover","origins",function(t){e._highlightOrigin(t.features[0].properties.naam)}),e._map.on("click","origin-labels",function(t){e._selectOrigin(t.features[0].properties)})}},{key:"_originList",value:function(){var e=this;e._callToAction.innerHTML="<span>Kies</span> een <span>herkomst</span>";var t=document.createElement("ul");e.config.origins.features.reverse().forEach(function(i){var r=document.createElement("li");r.innerHTML=i.properties.naam,r.addEventListener("mouseover",function(){e._highlightOrigin(i.properties.naam)},!1),r.addEventListener("click",function(){e._selectOrigin(i.properties)},!1),t.appendChild(r)}),e._listContainer.appendChild(t)}},{key:"_highlightOrigin",value:function(e){this._map.setFilter("origin-labels",["all",["==","function","herkomst"],["==","naam",e]]),this._map.setFilter("origin-labels-connector",["all",["==","function","herkomst"],["==","naam",e]])}},{key:"_selectOrigin",value:function(e){var t=this;t.session.origin=e.id;var i=t._map.getFilter("origins"),r=["==","id",t.session.origin];i.push(r),t._map.setFilter("origins",i);var n="";"34294"===e.originId?n="features_Amstelland_Station_Hoofddorp":"10220"===e.originId?n="features_Amstelland_Uithoorn_Busstation":"13412"===e.originId?n="features_Waterland_Korenstraat":"13527"===e.originId?n="features_Waterland_Stadskantoor":"35250"===e.originId?n="features_Zaanstreek_Morgensterstraat":"36003"===e.originId&&(n="features_Zaanstreek_Noordwachter");var a="features/"+n+".json";axios.get(a).then(function(e){200!==e.status&&console.log("foutje bedankt"),t._data={},t._data.originData=e.data,t._data.destinations=t._data.originData.find(function(e){return"destinations"===e.name}),void 0===t._map.getSource("destinations")?t._map.addSource("destinations",{type:"geojson",data:t._data.destinations}):t._map.getSource("destinations").setData(t._data.destinations),t._points.drawDestinations(),t._destinationList(),t._map.on("mouseover","destinations",function(e){t._highlightDestination(e.features[0].properties.id)}),t._map.on("click","destination-labels",function(e){t._initRoute(e.features[0].properties.id)})})}},{key:"_highlightDestination",value:function(e){var t=this;t._data.destinations.features.forEach(function(t){t.properties.state="inactive",t.properties.id===e&&(t.properties.state="highlighted")}),this._map.getSource("destinations").setData(t._data.destinations)}},{key:"_activateDestination",value:function(e){var t=this;t._data.destinations.features.forEach(function(t){t.properties.state="inactive",t.properties.id===e&&(t.properties.state="active")}),this._map.getSource("destinations").setData(t._data.destinations)}},{key:"_destinationList",value:function(){var e=this;e._listContainer.innerHTML="",e._callToAction.innerHTML="<span>Kies</span> een <span>bestemming</span>";var t=document.createElement("ul");e._data.destinations.features.sort(function(e,t){return e.properties.naam>t.properties.naam?1:t.properties.naam>e.properties.naam?-1:0}),e._data.destinations.features.forEach(function(i){var r=document.createElement("li");r.innerHTML=i.properties.naam,r.addEventListener("mouseover",function(){e._highlightDestination(i.properties.id)},!1),r.addEventListener("click",function(){e._initRoute(i.properties.id)},!1),t.appendChild(r)}),e._listContainer.appendChild(t)}},{key:"_initRoute",value:function(e){var t=this;t._map.getStyle().layers.forEach(function(e){e.id.indexOf("route-")>-1&&t._map.removeLayer(e.id)}),t.session.destination=e,t.session.traject=t.session.origin+"_"+e,t._activateDestination(e),t._data.traject=t._data.originData.find(function(t){if(t[0]&&t[0]&&t[0].features&&t[0].features.length>0)return t[0].features[0].properties.trajectId.split("_")[1]===e}),t._setRouteInfo(t._data.traject),t._data.traject.forEach(function(e){void 0===t._map.getSource("route-"+e.features[0].properties.routeId)?t._map.addSource("route-"+e.features[0].properties.routeId,{type:"geojson",data:e}):t._map.getSource("route-"+e.features[0].properties.routeId).setData(e)}),t._data.traject.forEach(function(e){t._map.addLayer({id:"route-"+e.features[0].properties.routeId+"-bus_old",type:"line",source:"route-"+e.features[0].properties.routeId,layout:{"line-join":"miter","line-cap":"square"},paint:{"line-color":{property:"routeVersion",type:"categorical",stops:[["prio",black],["alt","#999"]]},"line-width":4,"line-dasharray":[1,0]},filter:["all",["==","isNieuw",!1],["==","transport_type","bus"]]},"origins"),t._map.addLayer({id:"route-"+e.features[0].properties.routeId+"-bus_new",type:"line",source:"route-"+e.features[0].properties.routeId,layout:{"line-join":"miter","line-cap":"square"},paint:{"line-color":{property:"routeVersion",type:"categorical",stops:[["prio",purple],["alt",pink]]},"line-width":4,"line-dasharray":[4,4]},filter:["all",["==","isNieuw",!0],["==","transport_type","bus"]]},"origins"),t._map.addLayer({id:"route-"+e.features[0].properties.routeId+"-tram_old",type:"line",source:"route-"+e.features[0].properties.routeId,layout:{"line-join":"miter","line-cap":"square"},paint:{"line-color":{property:"routeVersion",type:"categorical",stops:[["prio",black],["alt","#999"]]},"line-width":4,"line-dasharray":[1,0]},filter:["all",["==","isNieuw",!1],["==","transport_type","tram"]]},"origins"),t._map.addLayer({id:"route-"+e.features[0].properties.routeId+"-tram_new",type:"line",source:"route-"+e.features[0].properties.routeId,layout:{"line-join":"miter","line-cap":"square"},paint:{"line-color":{property:"routeVersion",type:"categorical",stops:[["prio",purple],["alt",pink]]},"line-width":4,"line-dasharray":[1,1]},filter:["all",["==","isNieuw",!0],["==","transport_type","tram"]]},"origins"),t._map.addLayer({id:"route-"+e.features[0].properties.routeId+"-metro_old",type:"line",source:"route-"+e.features[0].properties.routeId,layout:{"line-join":"miter","line-cap":"square"},paint:{"line-color":{property:"routeVersion",type:"categorical",stops:[["prio",purple],["alt",pink]]},"line-width":4,"line-dasharray":[1,1]},filter:["all",["==","isNieuw",!1],["==","transport_type","metro"]]},"origins"),t._map.addLayer({id:"route-"+e.features[0].properties.routeId+"-metro_new",type:"line",source:"route-"+e.features[0].properties.routeId,layout:{"line-join":"miter","line-cap":"square"},paint:{"line-color":{property:"routeVersion",type:"categorical",stops:[["prio",black],["alt","#999"]]},"line-width":4,"line-dasharray":[1,0]},filter:["all",["==","isNieuw",!0],["==","transport_type","tram"]]},"origins"),t._map.addLayer({id:"route-"+e.features[0].properties.routeId+"-train_old",type:"line",source:"route-"+e.features[0].properties.routeId,layout:{"line-join":"miter","line-cap":"square"},paint:{"line-color":{property:"routeVersion",type:"categorical",stops:[["prio",purple],["alt",pink]]},"line-width":4,"line-dasharray":[1,1]},filter:["all",["==","isNieuw",!0],["==","transport_type","trein"]]},"origins"),t._map.addLayer({id:"route-"+e.features[0].properties.routeId+"-train_new",type:"line",source:"route-"+e.features[0].properties.routeId,layout:{"line-join":"miter","line-cap":"square"},paint:{"line-color":{property:"routeVersion",type:"categorical",stops:[["prio",purple],["alt",pink]]},"line-width":4,"line-dasharray":[1,1]},filter:["all",["==","isNieuw",!0],["==","transport_type","trein"]]},"origins")})}},{key:"_showDestinations",value:function(){var e=this,t={};t.layers=["destinations"],e.config.destinations=e._filterDestinations(e._map.queryRenderedFeatures(t))}},{key:"_setRouteInfo",value:function(e){var t=this;t._routeBlock.innerHTML="";var i=document.createElement("h3");i.innerHTML=e[0].features[0].properties.trajectNaam;var r=document.createElement("ul");e.forEach(function(e){var i=void 0;i=e.features&&!0===e.features[0].properties.isNieuw?"Nieuwe route":"Huidige route","firstAlt"!==e.features[0].properties.routeVersion&&"secondAlt"!==e.features[0].properties.routeVersion||(i+=" (alternatief)");var n=document.createElement("li"),a=document.createElement("input");a.type="checkbox",a.name=e.features[0].properties.routeId,a.checked=!0,n.appendChild(a);var o=document.createElement("label");o.innerHTML=i,n.appendChild(o),n.addEventListener("click",function(i){t._toggleRoute(i,e.features[0].properties.routeId)},!1),r.appendChild(n)}),t._routeBlock.appendChild(i),t._routeBlock.appendChild(r)}},{key:"_toggleRoute",value:function(e,t){var i=this,r=e.target.parentElement.querySelector("input[type=checkbox]"),n=["!=","routeId",r.name],a=i._map.getFilter("route-"+t+"-metro_new"),o=i._map.getFilter("route-"+t+"-bus_new"),s=i._map.getFilter("route-"+t+"-tram_new"),p=i._map.getFilter("route-"+t+"-train_new"),l=i._map.getFilter("route-"+t+"-metro_old"),u=i._map.getFilter("route-"+t+"-bus_old"),c=i._map.getFilter("route-"+t+"-tram_old"),d=i._map.getFilter("route-"+t+"-train_old");!1===r.checked?(a.push(n),o.push(n),s.push(n),p.push(n),l.push(n),u.push(n),c.push(n),d.push(n)):(a.pop(),o.pop(),s.pop(),p.pop(),l.pop(),u.pop(),c.pop(),d.pop()),i._map.setFilter("route-"+t+"-metro_new",a),i._map.setFilter("route-"+t+"-bus_new",o),i._map.setFilter("route-"+t+"-tram_new",s),i._map.setFilter("route-"+t+"-train_new",p),i._map.setFilter("route-"+t+"-metro_old",l),i._map.setFilter("route-"+t+"-bus_old",u),i._map.setFilter("route-"+t+"-tram_old",c),i._map.setFilter("route-"+t+"-train_old",d)}},{key:"_setBoundingBox",value:function(){var e=this,t=e._map.queryRenderedFeatures({layers:["origins","destinations","transfers"]}),i={type:"FeatureCollection",features:t},r=turf.bbox(i);e._map.fitBounds(r,{padding:{top:100,bottom:100,left:100,right:100},linear:!0})}},{key:"_switchView",value:function(){var e=this;this.nightview?(this.nightview=!1,e._map.setStyle("mapbox://styles/wijnemenjemee/cjcywszq502re2sobjc8d1e0z"),e._viewSelect.innerHTML="nacht",e._map.setPaintProperty("bus-old","line-color",black),e._map.setPaintProperty("bus-new","line-color",black),e._map.setPaintProperty("tram-old","line-color",black),e._map.setPaintProperty("tram-new","line-color",black),e._map.setPaintProperty("metro-old","line-color",black),e._map.setPaintProperty("metro-new","line-color",black)):(this.nightview=!0,e._map.setStyle("mapbox://styles/wijnemenjemee/cjdvrcqvn6dy32smopkqhd9q3"),e._viewSelect.innerHTML="dag",e._map.setPaintProperty("bus-old","line-color",white),e._map.setPaintProperty("bus-new","line-color",white),e._map.setPaintProperty("tram-old","line-color",white),e._map.setPaintProperty("tram-new","line-color",white),e._map.setPaintProperty("metro-old","line-color",white),e._map.setPaintProperty("metro-new","line-color",white))}},{key:"_filterOrigins",value:function(e){return{type:"FeatureCollection",features:e.features.filter(function(e,t,i){return i.map(function(e){return e.properties.naam}).indexOf(e.properties.naam)===t&&"herkomst"==e.properties.function})}}},{key:"_filterDestinations",value:function(e){var t=[];return e.filter(function(e){return!(t.indexOf(e.properties.naam)>-1)&&(t.push(e.properties.naam),!0)})}},{key:"_filterRoutes",value:function(e){var t=[];return e.filter(function(e){return!(t.indexOf(e.start_id)>-1)&&(t.push(e.start_id),!0)})}},{key:"_clearOrigin",value:function(){var e=this;this.session={origin:null,destination:null},this._listContainer.innerHTML="",e._map.getStyle().layers.forEach(function(t){(t.id.indexOf("route-")>-1||t.id.indexOf("origin")>-1||t.id.indexOf("destination")>-1)&&e._map.removeLayer(t.id)}),e._initMap()}}]),e}();