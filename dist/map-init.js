"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Map=function(){function e(t,i,n){_classCallCheck(this,e),this.element=document.getElementById(t);try{var r=this.element.getAttribute("data-config");this.customConfig=JSON.parse(r)}catch(e){this.customConfig=[],console.log(e)}this.nightview=!1,this.config={accessToken:"pk.eyJ1Ijoid2lqbmVtZW5qZW1lZSIsImEiOiJjaWgwZjB4ZGwwMGdza3FseW02MWNxcmttIn0.l-4VI25pfA5GKukRQTXnWA",style:"mapbox://styles/wijnemenjemee/cjcywszq502re2sobjc8d1e0z",hostContainer:t,center:[4.9,52.37],zoom:10.2,pitch:0,bearing:0,scrollZoom:!1},this.options={filters:!0,referenceList:!0},this.session={origin:null,destination:null},this.config.origins=i?JSON.parse(i):{},this.config.origins=JSON.parse(i),this._callToAction=document.getElementById("call-to-action"),this._listContainer=document.getElementById("list-container"),this._routeBlock=document.getElementById("route-block"),this._viewSelect=document.getElementById("view-select"),this._newOrigin=document.getElementById("new-origin"),this._newDestination=document.getElementById("new-destination"),this.interactionPopup=new InteractionPopup}return _createClass(e,[{key:"init",value:function(){var e=this,t=new MapWebGL(e.config);e._map=t.create(),e._background=new Background(e._map,e.config),e._origin=new Origin(e._map,e.config),e._points=new Points(e._map,e.config),e._lines=new Lines(e._map,e.config),e._map.on("style.load",function(){e._points.addOrigins(),e._initMap()})}},{key:"_initMap",value:function(){var e=this;void 0!=e._map.getLayer("destinations")&&e._map.removeLayer("destinations"),void 0!=e._map.getLayer("destination-labels")&&e._map.removeLayer("destination-labels"),void 0!=e._map.getLayer("destination-labels-connector")&&e._map.removeLayer("destination-labels-connector"),void 0!=e._map.getSource("originData")&&e._map.removeSource("originData"),e._points.drawOrigins(),e._originList(),e._map.on("mouseover","origins",function(t){e._highlightOrigin(t.features[0].properties.naam)}),e._map.on("click","origin-labels",function(t){e.session.origin=t.features[0].properties.id,e._selectOrigin(t.features[0].properties)}),e._viewSelect.addEventListener("click",function(){e._switchView()},!1),e._newOrigin.addEventListener("click",function(){e._clearOrigin()},!1),e._newDestination.addEventListener("click",function(){e._clearDestination()},!1)}},{key:"_originList",value:function(){var e=this;e._callToAction.innerHTML="<span>Kies</span> een <span>herkomst</span>";var t=document.createElement("ul");e.config.origins.features.reverse().forEach(function(i){var n=document.createElement("li");n.innerHTML=i.properties.naam,n.addEventListener("mouseover",function(){e._highlightOrigin(i.properties.naam)},!1),n.addEventListener("click",function(){e.session.origin=i.properties.id,e._selectOrigin(i.properties)},!1),t.appendChild(n)}),e._listContainer.appendChild(t)}},{key:"_highlightOrigin",value:function(e){this._map.setFilter("origin-labels",["all",["==","function","herkomst"],["==","naam",e]]),this._map.setFilter("origin-labels-connector",["all",["==","function","herkomst"],["==","naam",e]])}},{key:"_selectOrigin",value:function(e){function t(e){e.isSourceLoaded&&(i._map.off("sourcedata",t),setTimeout(function(){i._showDestinations(),i._destinationList()},1e3))}var i=this,n=i._map.getFilter("origins"),r=["==","id",i.session.origin];n.push(r),i._map.setFilter("origins",n);var a="";"34294"===e.originId?a="features_Amstelland_Station_Hoofddorp":"10220"===e.originId?a="features_Amstelland_Uithoorn_Busstation":"13412"===e.originId?a="features_Waterland_Korenstraat":"13527"===e.originId?a="features_Waterland_Stadskantoor":"35250"===e.originId?a="features_Zaanstreek_Morgensterstraat":"36003"===e.originId&&(a="features_Zaanstreek_Noordwachter"),this._map.addSource("originData",{type:"geojson",data:"features/"+a+".json"}),i._points.drawDestinations(),i._lines.draw(),i._points.drawTransfers(),i._map.on("sourcedata",t)}},{key:"_highlightDestination",value:function(e){console.log(e),this._map.setFilter("destination-labels",["all",["==","function","bestemming"],["==","id",e],["==","isNieuw",!0]]),this._map.setFilter("destination-labels-connector",["all",["==","function","bestemming"],["==","id",e],["==","isNieuw",!0]])}},{key:"_destinationList",value:function(){var e=this;e._listContainer.innerHTML="",e._callToAction.innerHTML="<span>Kies</span> een <span>bestemming</span>";var t=document.createElement("ul");e.config.destinations=e._removeAdam(e.config.destinations),e.config.destinations.sort(function(e,t){return e.properties.naam>t.properties.naam?1:t.properties.naam>e.properties.naam?-1:0}),e.config.destinations.forEach(function(i){var n=document.createElement("li");n.innerHTML=i.properties.naam,n.addEventListener("mouseover",function(){e._highlightDestination(i.properties.id)},!1),n.addEventListener("click",function(){console.log(i.properties),e._initRoute(i.properties.trajectId.split("_")[1])},!1),t.appendChild(n)}),e._listContainer.appendChild(t)}},{key:"_removeAdam",value:function(e){return e.forEach(function(e){e.properties.naam.indexOf("Amsterdam")>-1&&(e.properties.naam=e.properties.naam.slice(11,e.properties.naam.length))}),e}},{key:"_initRoute",value:function(e){var t=this;t.session.destination=e,t.session.traject=t.session.origin+"_"+e;var i=t._map.getFilter("destinations"),n=["==","id",t.session.destination];i.push(n),t._map.setFilter("destinations",i),t._map.setPaintProperty("destinations","circle-color","#fff"),t._map.setPaintProperty("destinations","circle-stroke-color","#000"),t._map.setLayoutProperty("destination-labels","icon-image","rect_black"),t._map.setLayoutProperty("destination-labels-connector","icon-image","connector_black"),t._highlightDestination(e),t._showOld(t.session.traject,t._map),t._showNew(t.session.traject,t._map),t._setRouteInfo(t.session.traject)}},{key:"_showDestinations",value:function(){var e=this,t={};t.layers=["destinations"],e.config.destinations=e._filterDestinations(e._map.queryRenderedFeatures(t))}},{key:"_showNew",value:function(e,t){var i=this;i._map.setFilter("bus-new",["all",["==","transport_type","bus"],["==","isNieuw",!0],["==","trajectId",e]]),i._map.setFilter("metro-new",["all",["==","transport_type","metro"],["==","isNieuw",!0],["==","trajectId",e]]),i._map.setFilter("tram-new",["all",["==","transport_type","tram"],["==","isNieuw",!1],["==","trajectId",e]]),i._map.setFilter("train-new",["all",["==","transport_type","trein"],["==","isNieuw",!1],["==","trajectId",e]]),i._map.setFilter("transfers",["all",["==","function","overstap"],["==","trajectId",i.session.traject],["==","isNieuw",!0]]),i._map.setFilter("transfer-labels",["all",["==","function","overstap"],["==","trajectId",i.session.traject],["==","isNieuw",!0]])}},{key:"_showOld",value:function(e,t){var i=this;t.setFilter("bus-old",["all",["==","transport_type","bus"],["==","isNieuw",!1],["==","trajectId",e]]),t.setFilter("metro-old",["all",["==","transport_type","metro"],["==","isNieuw",!1],["==","trajectId",e]]),t.setFilter("tram-old",["all",["==","transport_type","tram"],["==","isNieuw",!1],["==","trajectId",e]]),t.setFilter("train-old",["all",["==","transport_type","trein"],["==","isNieuw",!1],["==","trajectId",e]]),t.setFilter("transfers",["all",["==","function","overstap"],["==","trajectId",i.session.traject],["==","isNieuw",!1]]),t.setFilter("transfer-labels",["all",["==","function","overstap"],["==","trajectId",i.session.traject],["==","isNieuw",!1]])}},{key:"_setRouteInfo",value:function(e){var t=this;t._routeBlock.innerHTML="";var i=t._map.querySourceFeatures(["originData"],{filter:["all",["!has","function"],["==","trajectId",e]]});console.log(i);var n=[];i.forEach(function(e){n.push(e.properties)});var r=t._groupBy(n,"routeId");for(var a in r)r[a]=t._filterRoutes(r[a]);var o=document.createElement("h3"),s=r[Object.keys(r)[0]];console.log(s),o.innerHTML=s[0].trajectNaam;var l=document.createElement("ul");for(var c in r){var p=void 0;p=!0===r[c][0].isNieuw?"Nieuwe route":"Huidige route","firstAlt"!==r[c][0].routeVersion&&"secondAlt"!==r[c][0].routeVersion||(p+=" (alternatief)");var u=document.createElement("li"),m=document.createElement("input");m.type="checkbox",m.name=r[c][0].routeId,m.checked=!0,u.appendChild(m);var d=document.createElement("label");d.innerHTML=p,u.appendChild(d),u.addEventListener("click",function(e){t._toggleRoute(e)},!1),l.appendChild(u)}t._routeBlock.appendChild(o),t._routeBlock.appendChild(l)}},{key:"_toggleRoute",value:function(e){var t=this,i=e.target.parentElement.querySelector("input[type=checkbox]"),n=["!=","routeId",i.name],r=t._map.getFilter("metro-new"),a=t._map.getFilter("bus-new"),o=t._map.getFilter("tram-old"),s=t._map.getFilter("train-new"),l=t._map.getFilter("metro-old"),c=t._map.getFilter("bus-old"),p=t._map.getFilter("tram-old"),u=t._map.getFilter("train-old");!1===i.checked?(r.push(n),a.push(n),o.push(n),s.push(n),l.push(n),c.push(n),p.push(n),u.push(n)):(r.pop(),a.pop(),o.pop(),s.pop(),l.pop(),c.pop(),p.pop(),u.pop()),t._map.setFilter("metro-new",r),t._map.setFilter("bus-new",a),t._map.setFilter("tram-new",o),t._map.setFilter("train-new",s),t._map.setFilter("metro-old",l),t._map.setFilter("bus-old",c),t._map.setFilter("tram-old",p),t._map.setFilter("train-old",u)}},{key:"_setBoundingBox",value:function(){var e=this,t=e._map.queryRenderedFeatures({layers:["origins","destinations","transfers"]}),i={type:"FeatureCollection",features:t},n=turf.bbox(i);e._map.fitBounds(n,{padding:{top:100,bottom:100,left:100,right:100},linear:!0})}},{key:"_switchView",value:function(){var e=this;this.nightview?(this.nightview=!1,e._map.setStyle("mapbox://styles/wijnemenjemee/cjcywszq502re2sobjc8d1e0z"),e._viewSelect.innerHTML="nacht",e._map.setPaintProperty("bus-old","line-color",black),e._map.setPaintProperty("bus-new","line-color",black),e._map.setPaintProperty("tram-old","line-color",black),e._map.setPaintProperty("tram-new","line-color",black),e._map.setPaintProperty("metro-old","line-color",black),e._map.setPaintProperty("metro-new","line-color",black)):(this.nightview=!0,e._map.setStyle("mapbox://styles/wijnemenjemee/cjdvrcqvn6dy32smopkqhd9q3"),e._viewSelect.innerHTML="dag",e._map.setPaintProperty("bus-old","line-color",white),e._map.setPaintProperty("bus-new","line-color",white),e._map.setPaintProperty("tram-old","line-color",white),e._map.setPaintProperty("tram-new","line-color",white),e._map.setPaintProperty("metro-old","line-color",white),e._map.setPaintProperty("metro-new","line-color",white))}},{key:"_filterOrigins",value:function(e){return{type:"FeatureCollection",features:e.features.filter(function(e,t,i){return i.map(function(e){return e.properties.naam}).indexOf(e.properties.naam)===t&&"herkomst"==e.properties.function})}}},{key:"_filterDestinations",value:function(e){var t=[];return e.filter(function(e){return!(t.indexOf(e.properties.naam)>-1)&&(t.push(e.properties.naam),!0)})}},{key:"_filterRoutes",value:function(e){var t=[];return e.filter(function(e){return!(t.indexOf(e.start_id)>-1)&&(t.push(e.start_id),!0)})}},{key:"_clearOrigin",value:function(){var e=this;this.session={origin:null,destination:null},this._listContainer.innerHTML="",e._initMap()}},{key:"_clearDestination",value:function(){var e=this;this.session.destination=null,this._listContainer.innerHTML="",e._showDestinations(),e._destinationList()}},{key:"_clearRoutes",value:function(){var e=this;this._newRoute.innerHTML="",this._oldRoute.innerHTML="",e._map.setFilter("bus-new",["all",["==","transport_type","bus"],["==","isNieuw",!0],["==","trajectId",""]]),e._map.setFilter("metro-new",["all",["==","transport_type","metro"],["==","isNieuw",!0],["==","trajectId",""]]),e._map.setFilter("tram-new",["all",["==","transport_type","tram"],["==","isNieuw",!1],["==","trajectId",""]]),e._map.setFilter("bus-old",["all",["==","transport_type","bus"],["==","isNieuw",!1],["==","trajectId",""]]),e._map.setFilter("metro-old",["all",["==","transport_type","metro"],["==","isNieuw",!1],["==","trajectId",""]]),e._map.setFilter("tram-old",["all",["==","transport_type","tram"],["==","isNieuw",!1],["==","trajectId",""]]),e._map.setFilter("bus-old-icon",["all",["==","transport_type","bus"],["==","isNieuw",!1],["==","trajectId",""]]),e._map.setFilter("metro-old-icon",["all",["==","transport_type","metro"],["==","isNieuw",!1],["==","trajectId",""]]),e._map.setFilter("tram-old-icon",["all",["==","transport_type","tram"],["==","isNieuw",!1],["==","trajectId",""]]),e._map.setFilter("transfers",["all",["==","function","overstap"],["==","trajectId",""],["==","isNieuw",!0]]),e._map.setFilter("transfer-labels",["all",["==","function","overstap"],["==","trajectId",""],["==","isNieuw",!0]])}},{key:"_groupBy",value:function(e,t){return e.reduce(function(e,i){return(e[i[t]]=e[i[t]]||[]).push(i),e},{})}}]),e}();